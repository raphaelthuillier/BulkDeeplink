<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bulk Deeplink</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/react-select@5.7.0/dist/react-select.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 20px;
      }
      .config-panel {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
        max-width: 800px;
        margin: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      textarea {
        width: 100%;
        font-family: monospace;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        background: #e85d1f;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.9;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        margin: 8px 0;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div id="root">Chargement...</div>

    <!-- React + ReactDOM + ReactSelect -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/react-select@5.7.0/dist/react-select.umd.js"></script>

    <script type="text/javascript">
      const { useState, useEffect, useReducer } = React;
      const Select = window.ReactSelect.default;

      const initialState = {
        programs: [],
        loading: true,
        selectedProgram: null,
        comid: "",
        rawUrls: "",
        trackedUrls: [],
      };

      function reducer(state, action) {
        return { ...state, [action.type]: action.payload };
      }

      function App() {
        const [state, dispatch] = useReducer(reducer, initialState);

        useEffect(() => {
          let mounted = true;
          const BASE_URL =
            "https://webhook.time1.io/webhook/080de059-8676-4214-88dd-40e930782d34";
          const API_URL =
            "https://api.allorigins.win/raw?url=" +
            encodeURIComponent(BASE_URL);

          fetch(API_URL)
            .then((res) => {
              if (!res.ok)
                throw new Error("Erreur réseau (" + res.status + ")");
              return res.json();
            })
            .then((json) => {
              const programsArray = Array.isArray(json)
                ? json
                : Array.isArray(json.programs)
                ? json.programs
                : [];
              if (mounted)
                dispatch({ type: "programs", payload: programsArray });
            })
            .catch((err) => {
              console.error("❌ Erreur JSON:", err);
              alert(
                "Erreur de chargement des programmes (CORS ou réseau). Essayez d'actualiser la page."
              );
            })
            .finally(() => {
              if (mounted) dispatch({ type: "loading", payload: false });
            });

          return () => (mounted = false);
        }, []);

        if (state.loading)
          return React.createElement(
            "p",
            { style: { textAlign: "center" } },
            "⏳ Chargement des programmes..."
          );

        const buildTrackedUrls = () => {
          if (!state.selectedProgram || !state.comid.trim()) {
            alert("⚠️ Sélectionnez un annonceur et un COMID.");
            return;
          }
          const progid = state.selectedProgram.id;
          const comid = state.comid.trim();
          const lines = state.rawUrls
            .split("\n")
            .map((l) => l.trim())
            .filter((l) => l);
          const results = lines.map((line) => {
            let name = "";
            let url = line;
            if (line.includes("|")) {
              const parts = line.split("|");
              name = parts[0].trim();
              url = parts[1].trim();
            }
            const encoded = encodeURIComponent(url);
            const tracked = `https://tracking.publicidees.com/clic.php?progid=${progid}&partid=${comid}&dpl=${encoded}`;
            return { name, url, tracked };
          });
          dispatch({ type: "trackedUrls", payload: results });
        };

        const copyToClipboard = () => {
          if (!state.trackedUrls.length) return alert("Aucune URL à copier.");
          const text = state.trackedUrls
            .map((u) => (u.name ? `${u.name} | ` : "") + u.tracked)
            .join("\n");
          navigator.clipboard.writeText(text);
          alert("✅ Liens copiés !");
        };

        return React.createElement(
          "div",
          { className: "config-panel" },
          React.createElement("h2", null, "🔗 Générateur d’URLs Trackées"),
          React.createElement(
            "div",
            { className: "config-row" },
            React.createElement("label", null, "Annonceur :"),
            React.createElement(Select, {
              classNamePrefix: "react-select",
              options: state.programs.map((p) => ({
                value: p.id,
                label: p.name,
              })),
              onChange: (o) => {
                const prog = state.programs.find((p) => p.id === o.value);
                dispatch({ type: "selectedProgram", payload: prog });
              },
              placeholder: "🔍 Sélectionner un annonceur...",
            })
          ),
          React.createElement("label", null, "ProgID :"),
          React.createElement("input", {
            readOnly: true,
            value: state.selectedProgram ? state.selectedProgram.id : "",
          }),
          React.createElement("label", null, "ComID :"),
          React.createElement("input", {
            value: state.comid,
            onChange: (e) =>
              dispatch({ type: "comid", payload: e.target.value }),
            placeholder: "ex : 2",
          }),
          React.createElement(
            "label",
            null,
            "Liste d’URLs (une par ligne ou 'Nom | URL') :"
          ),
          React.createElement("textarea", {
            rows: 6,
            value: state.rawUrls,
            onChange: (e) =>
              dispatch({ type: "rawUrls", payload: e.target.value }),
            placeholder:
              "ex :\nhttps://www.auchan.fr/\nPromo rentrée | https://www.fnac.com/",
          }),
          React.createElement(
            "div",
            { style: { marginTop: "10px" } },
            React.createElement(
              "button",
              { onClick: buildTrackedUrls },
              "🎯 Générer les liens "
            ),
            " ",
            React.createElement(
              "button",
              {
                onClick: copyToClipboard,
                style: { background: "#444", marginLeft: "8px" },
              },
              "📋 Copier"
            )
          ),
          state.trackedUrls.length > 0 &&
            React.createElement(
              "ul",
              null,
              state.trackedUrls.map((u, i) =>
                React.createElement(
                  "li",
                  { key: i },
                  u.name && React.createElement("strong", null, u.name + " : "),
                  React.createElement(
                    "a",
                    {
                      href: u.tracked,
                      target: "_blank",
                      rel: "noopener noreferrer",
                    },
                    u.tracked
                  )
                )
              )
            )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        React.createElement(App)
      );
    </script>
  </body>
</html>
